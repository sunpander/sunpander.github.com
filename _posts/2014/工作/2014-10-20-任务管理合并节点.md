---
layout: post
title: 任务管理修改之合并节点 
---  
接前一篇,任务管理需求

---
##怎么修改##
1. 想:维持现有审批流维护不变,把报表维度相关信息更多的设置在任务上面..
2. 想:能再审批流,任务之间插入一层,类似任务模板用来启动新的任务是实例.可预留一些参数值,启动实例的时候再设置.
3. 想:尽可能多地利用现有内容,目前对于多个节点对应一个节点的情况,是通过任务关联实现的..一个任务结束开始另一个...能否两个一起启动,但A任务中的一个节点是需要另一个任务完成才能进行操作的..
4. 想:对于任务模板,可批量定义任务,定义的时候把一些属性(比如维度)定义为参数方式,在复制新增的时候,弹出参数共修改,修改后再批量复制..

**借此机会重新改造下,一步步完善**
1. 首先把现在bootstrap端的哪些审批提交,同步在后台也提供下.虽然已经有了,做个可发布的画面出来,稍微正规点的.[先用一个类似方法测试的那个页面类似的,左右下的结构.]
2. 
##开始改##
1. 任务定义的时候,可以为节点设置额外的属性(包括,关联任务,合并节点,额外维度等)..那么对该节点要特殊处理.暂定在节点上右键设为合并节点,弹出窗体,选择关联任务等相关信息.
2. 任务定义的详细流程信息存在wf10表中,用目前的wfRoleType存放是否为一级节点,目前roleType只有一种情况是start的为开始节点,否则为null,增加一个值merge.标志位合并,另外 wfStepTime字段存放关联子任务信息,原本想用来控制节点完成日期的,一直没用..
3. 这个不急..在设置任务维度的时候,目前只选择期间维度,希望可以选择多个维度类型对应的多个值,为节点绑定维度...
4. 
>特殊处理0.存储一个标记,标记出来是合并的节点 ;1.启动该任务时,遇到合并的节点,不生成虚拟报表,或预留一个特殊的标记 --在wf10,wf04中都有report_param 字段,预留来存放报表参数的,一直没用,这里用上,来存放报表合并的一些信息.[也可能有其他,使用字符串拼接]
>2.查看到该节点的待办任务时,(可依据任务节点属性,也可以依据虚拟报表标记.)显示为合并任务. 3.对于合并任务,点击提交时必须设置一个报表.该报表可以是合并后的,或者其他的什么都行....4.对于合并的任务,点击处理任务时,跳转到合并报表界面,进行报表合并的工作.5.合并报表页面,查询该任务对应的子任务,提供可供选择可并的报表,进行合并,查看,可选择一个合并后的进行发布提交 6.当合并报表任务的节点被驳回时,处理驳回任务时,可选择继续驳回,或修改等..7.如果选择继续驳回,则启动关联的任务..8.关联任务提交,再重新合并...    

5. 任务可以批了启动,添加选择框,能够多选,启动,依次启动即可.(如果失败,自己手动再次启动)同时批量回收,批量复制新增,批量删除  
6. 
>1.设置合并节点时,要验证只能末端设置,2,合并节点没报表,那么填报开始页面上应该显示什么.  


2. 用de05 表中的taskType作为任务类型(任务模板,一般任务)
3. BUSINESS_DIM_INFO 原本存放的期间维度,还可以存放其他值,包括其他维度类型,以及存为变量
4. TASK_PARAMS 除了现在暂时用的.reComputeEveryTime:false,writeEveryLevel:2 还可以继续续,比如 paramterToCopy:a,b,c
5. TASK_STATUS 还作为状态,但期望新增一些状态,另外REMARK 用来作为 状态备注

添加一个查询方法,查询任务详情(目前的也可用哦),少一个维度信息.
穿插一个任务,,目前人员维度管理通过id字段,改成通过userEname字段,另外新增用户是转成小写了,去掉
新增维度授权.
1. 新增维度时,当英文名称为dimension 设为id ...想画面,菜单一样...内置
2. 在角色授权画面,查询类型为维度的时候特殊处理,查询de02表
3. 新增一个方法getAccessListByUser 根据传入的对象类型id,获取登陆用户的权限列表--查询授权的维度列表
批量复制任务的时候,重新制定期间维度.

维度维护画面,维度树节点可移动,可复制新增(包含自己点一起复制)
任务报表关联画面--完善查询报表数据,多张表时自动分tab创建grid..同时把报表树,报表列表的拿到.
批量复制任务时,关联任务如何处理??
--10月27日
获取授权的维度,同时传入一个taskId,获取对应维度当前状态(所在位置,和报表id)
---暂缓.层次不匹配..多审批层..角色流快速添加改进(之前不带父子关系,添加上父子关系的)
生成报表名称时候,可配置是否将人员姓名也显示在报表名称中
任务树中不能重复挂在同一个目录下..
---暂缓,都在本机,直接读取即可,增加一个ftp功能.直接ftp去查看报表相关文件信息,可下载,查看.
把之前冻结行列移过来,可以在线查看..数据没能读出来是因为默认用的03读的,而目前大多是07版的excel导致,已经可以了....目前这个画面,查一个直接点击报表浏览,类似报表管理画面的浏览,移植过来即可..



..任务关联大树 构建出来供查询..
新增一个方法传入任务业务主键,返回是否已完成.
任务批量复制,包括关联关系?--管理关系如何处理?---目录上面复制,包含目录一起复制
任务批量修改任务名称(字符串替换)
设置合并节点,做为一个独立的tab页
bug:发布公告连着点击发布,,发布后没能设置返回的id.导致还是一个新增

合并节点的回退也调用之前的 任务完成方法...
..查询

..维度信息重复的bug

11月3号:
任务维度,可以绑定多个类型.独立绑定..
再次启动时,查询已完成的,可启动的..
bug.删除任务后,同时刷新目录
..维度授权要求按人员(每个人员的有权的维度不同,所以直接利用角色会导致建很多角色)
..报表权限除了查询授权的外,也查询下登陆用户自己创建的...

角色授权树节点上添加一个权限菜单

11-10
例会,报表数据源查询(花了点时间在 压缩和解压缩上)
---明天做绑定多维度的情况..
下午弄了下数据源查询画面
---周三 上午看绑定多维度,添加一个维度类型添加的,测试了下多维度报表生成,调整了下画面,营销页面稍微改了下
思路很乱,早上接到不能加入java项目,还要继续shenxin不咋爽啊
---明天都周四了,怎么搞--帮任务管理弄通顺了,,主要是页面间方便性
下拉框却一个下拉grid的..
数据源画面还待完善,,
很想快点集成下cms维护
---

###下周计划
1. 任务添加一个已完成状态.在所有实例结束时设置为已完成状态
3. 合并节点回退任务履历,意见信息
4. combox下拉grid的控件
5. 用户角度查看所在角色以及删除角色
6. 从资源角度,授权到角色
###遗留问题(待解决,不紧急)
1. java端框架性能测试.
2. 任务管理UI优化.(从用户角度,分解多个简单操作的画面)
3. 报表控件spreedsheetgear在保存excel文件时,使用openxml 格式,java 无法正常读取.
4. bfr报表数据源管理BS实现.








